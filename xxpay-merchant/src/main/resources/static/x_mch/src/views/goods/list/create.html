<div class="layui-card-header layui-card" style="margin-bottom: 0">
    <span class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>商品管理</cite></a>
        <a><cite>新增商品</cite></a>
    </span>
</div>
<style>
    .layui-form-label {
        width:15% !important;
        margin-left:1%;
    }
    .layui-input-inline {
        width: 33% !important;
    }
    .layui-layedit-tool {
        padding: 0px 0px;
    }
</style>
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-tab layui-tab-brief">
            <ul class="layui-tab-title">
                <li class="layui-this">新增商品</li>
            </ul>
            <div class="layui-tab-content">
                <form class="layui-form layui-form-pane" action="">
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品名称</label>
                        <div class="layui-input-inline">
                            <input type="text" id="goodsName" name="goodsName" placeholder="请输入商品名称" class="layui-input" lay-verify="required" autocomplete="off">
                        </div>
                        <label class="layui-form-label">商品分类</label>
                        <div class="layui-input-inline">
                            <select name="categoryId" id="categoryId" lay-search=""  lay-verify="required">
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <!--<label class="layui-form-label">商品所属行业</label>-->
                        <!--<div class="layui-input-inline">-->
                            <!--<input type="radio" name="industryType" value="1" title="餐饮商品" checked="checked">-->
                            <!--<input type="radio" name="industryType" value="2" title="电商商品">-->
                        <!--</div>-->
                        <label class="layui-form-label">商品标签</label>
                        <div class="layui-input-inline">
                            <input type="text" id="goodsTag" name="goodsTag" placeholder="请输入商品标签，以逗号隔开，不超过10个字" class="layui-input" autocomplete="off">
                        </div>
                        <label class="layui-form-label">单位</label>
                        <div class="layui-input-inline">
                            <input type="text" id="unit" name="unit" placeholder="请输入单位" class="layui-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品类型</label>
                        <div class="layui-input-inline">
                            <input type="radio" name="goodsType" value="1" title="单一商品" lay-filter="goodsType" checked="checked">
                            <input type="radio" name="goodsType" value="2" title="组合商品" lay-filter="goodsType">
                        </div>
                        <div id="subGoodsIdSelect" class="layui-hide">
                            <label class="layui-form-label">子商品ID</label>
                            <div class="layui-input-inline">
                                <input type="text" id="subGoodsId" name="subGoodsId" readonly placeholder="请选择子商品ID" class="layui-input" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品所属模块</label>
                        <div class="layui-input-inline" style="width: 80% !important;">
                            <input type="checkbox" name="" title="普通商品" value="0" lay-skin="primary" checked>
                            <input type="checkbox" name="" title="新品" value="1" lay-skin="primary">
                            <input type="checkbox" name="" title="热卖" value="2" lay-skin="primary">
                            <input type="checkbox" name="" title="促销" value="3" lay-skin="primary">
                            <input type="checkbox" name="" title="限时抢购" value="4" lay-skin="primary">
                            <input type="checkbox" name="" title="会员专享" value="5" lay-skin="primary">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品售价(元)</label>
                        <div class="layui-input-inline">
                            <input type="text" id="cellingPrice" name="cellingPrice" placeholder="请输入商品售价"  lay-verify="required" class="layui-input" autocomplete="off">
                        </div>
                        <label class="layui-form-label">商品进价(元)</label>
                        <div class="layui-input-inline">
                            <input type="text" id="buyingPrice" name="buyingPrice" placeholder="请输入商品进价" class="layui-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">会员价(元)</label>
                        <div class="layui-input-inline">
                            <input type="text" id="memberPrice" name="memberPrice" placeholder="请输入会员价" class="layui-input" autocomplete="off">
                        </div>
                        <label class="layui-form-label">虚拟销量</label>
                        <div class="layui-input-inline">
                            <input type="text" id="virtualSaleNum" name="virtualSaleNum" placeholder="请输入虚拟销量" class="layui-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">是否添加属性</label>
                        <div class="layui-input-inline">
                            <input type="radio" name="goodsPropsType" value="0" title="不添加" lay-filter="goodsPropsType" checked="checked">
                            <input type="radio" name="goodsPropsType" value="1" title="添加" lay-filter="goodsPropsType">
                        </div>
                        <div class="layui-hide" id="goodsPropsSelect">
                            <label class="layui-form-label">选择属性分类</label>
                            <div class="layui-input-inline">
                                <input type="text" id="propsCategoryIds" name="propsCategoryIds" placeholder="请选择属性" readonly class="layui-input" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">是否限制门店</label>
                        <div class="layui-input-inline">
                            <input type="radio" name="storeLimitType" value="0" title="不限门店" lay-filter="storeLimitType" checked="checked">
                            <input type="radio" name="storeLimitType" value="1" title="限制门店" lay-filter="storeLimitType">
                        </div>
                        <div class="layui-hide" id="storeSelect">
                            <label class="layui-form-label">选择门店</label>
                            <div class="layui-input-inline">
                                <input type="text" id="storeIds" name="storeIds" placeholder="请选择门店" readonly class="layui-input" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">是否限制库存</label>
                        <div class="layui-input-inline">
                            <input type="radio" name="stockLimitType" value="1" title="不限库存" lay-filter="stockLimitType" checked="checked">
                            <input type="radio" name="stockLimitType" value="2" title="限制库存" lay-filter="stockLimitType">
                        </div>
                        <div class="layui-hide" id="stockNumSelect">
                            <label class="layui-form-label">库存数量</label>
                            <div class="layui-input-inline">
                                <input type="text" id="stockNum" name="stockNum" placeholder="请输入库存数量" class="layui-input" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品主图</label>
                        <div class="layui-input-inline">
                            <input type="hidden" name="imgPathMain" id="imgPathMain" class="layui-hide">
                            <img class="uploadImg layui-hide" style="height:38px; margin-left:30px;cursor: pointer;" title="点击放大" />
                            <button class="uploadImgBtn layui-btn layui-btn-sm" type="button" style="margin-left: 20px;margin-top: 5px;">上传图片</button>
                            <button class="delImgBtn layui-btn layui-btn-sm layui-btn-danger layui-hide" style="margin-top: 5px;" type="button">删除图片</button>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品详情图（上限4张）</label>
                        <div class="layui-input-inline">
                            <button type="button" class="layui-btn layui-btn-sm" id="multiple_img_upload" style="margin-left: 20px;margin-top: 5px;">多图片上传</button>
                            <button class="delImgsBtn layui-btn layui-btn-sm layui-btn-danger layui-hide" style="margin-top: 5px;" type="button">删除图片</button>
                        </div>
                        <!--<label class="layui-form-label">预览</label>-->
                        <div class="layui-input-inline">
                            <input type="hidden" name="imgPathMore" class="multiple_show_img" value="">
                            <div class="layui-upload">
                                <blockquote class="layui-elem-quote layui-quote-nm" style="margin-left: 15px;font-size: xx-small">
                                    <span>预览：</span>
                                <div class="layui-upload-list" id="div-slide_show"></div>
                                </blockquote>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">生产日期</label>
                        <div class="layui-input-inline">
                            <input type="text" id="producedBeginTime" name="producedBeginTime" placeholder="请选择生产日期" readonly autocomplete="off" class="layui-input">
                        </div>
                        <label class="layui-form-label">保质期(天)</label>
                        <div class="layui-input-inline">
                            <input type="text" id="expiration" name="expiration" placeholder="请输入保质期" class="layui-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">品牌</label>
                        <div class="layui-input-inline">
                            <input type="text" id="brand" name="brand" placeholder="请输入品牌" class="layui-input" autocomplete="off">
                        </div>
                        <label class="layui-form-label">供应商</label>
                        <div class="layui-input-inline">
                            <input type="text" id="supplier" name="supplier" placeholder="请输入供应商" class="layui-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品详情</label>
                        <input hidden type="text" id="goodsDesc" name="goodsDesc">
                        <div class="layui-input-inline layedit-content detail-body" style="width: 82.5% !important;">
                            <textarea id="layedit-content" placeholder="请输入商品详情"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">图文详情</label>
                        <div class="layui-input-inline" style="width: 82.5% !important;">
                            <textarea id="graphicDesc" name="graphicDesc" placeholder="请输入图文详情" class="layui-textarea"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item  layui-form-text">
                        <div class="layui-input-block" style="padding-bottom: 20px;">
                            <button type="button" class="layui-btn" lay-submit="" lay-filter="goodsAdd">保存</button>
                            <a class="layui-btn" lay-href="/goods/list/">返回</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    layui.use(['admin', 'form', 'view', 'laydate', 'upload', 'setter', 'layedit'],function(){
        var form = layui.form
            ,$ = layui.$
            ,admin = layui.admin
            ,element = layui.element
            ,layedit = layui.layedit
            ,view = layui.view
            ,laydate = layui.laydate
            ,upload = layui.upload
            ,setter = layui.setter
            ,layer = layui.layer ;
        // 导航
        element.render('breadcrumb', 'breadcrumb');
        var multiple_images = [];

        //生成商品详情富文本编辑器
        var contentIndex = layedit.build('layedit-content',{
            hideTool: [
                'undo','redo' //撤销重做--实验功能，不推荐使用
                ,'code', 'strong', 'italic', 'underline', 'del',
                ,'addhr' //添加水平线
                ,'|', 'fontFomatt','fontfamily','fontSize', //段落格式，字体样式，字体颜色
                , 'colorpicker', 'fontBackColor'//字体颜色，字体背景色
                , 'face', '|', 'left', 'center', 'right', '|', 'link', 'unlink'
                ,'image'//原版上传图片
                ,'images'//多图上传
                , 'image_alt'//上传图片拓展
                , 'attachment'//上传附件
                , 'video' //视频上传
                ,'anchors' //锚点
                , '|', 'table'//插入表格
                ,'customlink'//插入自定义链接
                ,'fullScreen'//全屏
                ,'preview'//预览
            ]
        });

        //生成图文详情富文本编辑器
        var headers = {};
        headers[setter.request.tokenName] = layui.data(setter.tableName)[setter.request.tokenName];
        layedit.set({
            uploadImage: {
                url: layui.setter.baseUrl + '/upload/goods'
                , headers: headers
                , size: 1024  //仅支持1M图片上传
            }
        });
        var graphicIndex = layedit.build('graphicDesc',{
            hideTool: [
                'link'//全屏
                ,'unlink'//预览
            ]
        });

        admin.req({
            type: 'get',
            url: layui.setter.baseUrl + '/mchGoods/category/list',
            error: function(err){
                layer.alert(err);
            },
            success: function(res){
                if(res.code == 0){
                    $.each(res.data, function(key) {
                        $('#categoryId').append('<option value="' + this.categoryId +'">' + this.categoryName + '</option>');
                        form.render();
                    })
                }
            }
        });

        form.on('radio(goodsType)', function(data){
            if (data.value == 1){
                $("#subGoodsIdSelect").addClass("layui-hide");
            }else {
                view.xxpayPopup("选择子商品", "goods/list/sub_goods", {outGoodsId: null}, {btn:false, area:["60%", "80%"]});
                $("#subGoodsIdSelect").removeClass("layui-hide");
            }
        });

        form.on('radio(stockLimitType)', function(data){
            if (data.value == 1){
                $("#stockNumSelect").addClass("layui-hide");
            }else {
                $("#stockNumSelect").removeClass("layui-hide");
            }
        });

        form.on('radio(goodsPropsType)', function(data){
            if (data.value == 0){
                $("#goodsPropsSelect").addClass("layui-hide");
            }else {
                view.xxpayPopup("选择属性分类", "goods/list/goods_props", null, {btn:false, area:["60%", "80%"]});
                $("#goodsPropsSelect").removeClass("layui-hide");
            }
        });

        form.on('radio(storeLimitType)', function(data){
            if (data.value == 0){
                $("#storeSelect").addClass("layui-hide");
            }else {
                view.xxpayPopup("选择门店", "account/coupon/points_stores", null, {btn:false, area:["60%", "80%"]});
                $("#storeSelect").removeClass("layui-hide");
            }
        });

        //监听提交
        form.on('submit(goodsAdd)', function(data){
            data.field.imgPathMore = multiple_images.toLocaleString();
            data.field.graphicDesc = layedit.getContent(graphicIndex);
            data.field.goodsDesc = layedit.getContent(contentIndex);
            var reqData = data.field;

            if ((reqData.goodsTag).replace(",", "").replace("，", "").length > 10) {
                layer.msg("商品标签最多10个字！");
                return false;
            }

            if (reqData.goodsType == 2 && !reqData.subGoodsId) {
                layer.msg("请选择子商品！");
                return false;
            }

            if (reqData.goodsPropsType == 1 && !reqData.propsCategoryIds) {
                layer.msg("请选择商品属性！");
                return false;
            }

            if (reqData.storeLimitType == 1 && !reqData.storeIds) {
                layer.msg("请选择门店！");
                return false;
            }

            if (reqData.stockLimitType == 2 && !reqData.stockNum) {
                layer.msg("库存数量不能为空！");
                return false;
            }

            var goodsModule = '';
            $('input[type=checkbox]:checked').each(function() {
                goodsModule = goodsModule + $(this).val() + ",";
            });
            goodsModule = goodsModule.substring(0, goodsModule.length-1);

            reqData.goodsModule = goodsModule;

            reqData.cellingPrice = reqData.cellingPrice * 100;
            reqData.buyingPrice = reqData.buyingPrice * 100;
            reqData.memberPrice = reqData.memberPrice * 100;

            // 在这个回调函数里面写ajax提交
            admin.req({
                type: 'post',
                url: layui.setter.baseUrl + '/mchGoods/add',
                data: data.field,
                success: function(res){
                    if(res.code == 0){
                        layer.msg("保存成功");
                        setTimeout(function () {
                            location.hash = '/goods/list/';
                        },1500)
                    }
                }
            });
            return false;//阻止跳转
        });

        var uploadInst = upload.render({
            elem: '.uploadImgBtn'
            , url: layui.setter.baseUrl + '/upload/goods'
            , headers: headers
            , size: 2048  //仅支持2M图片上传
            ,before: function (obj) {
                obj.preview(function(index, file, result) {
                    $('#img').attr('src', result);
                })
            },done: function(res){
                //如果上传失败
                if(res.code != 0){
                    return layer.msg('上传失败['+res.msg+']', {icon: 2});
                }
                //上传成功
                $("#imgPathMain").val(res.data);
                var divElem = $(this.item).parent();
                divElem.find('.uploadImg').attr("src", res.data).removeClass('layui-hide');
                divElem.find('.delImgBtn').removeClass('layui-hide');
                divElem.find('.uploadImgBtn').text('重新上传');
            }
        });
        //点击[图片] 按钮， 事件
        $('.uploadImg').click(function(){
            var imgSrc = $(this).attr('src');
            layer.photos({photos: {
                    "title": "查看上传图片", //相册标题
                    "id": 1, //相册id
                    "start": 0, //初始显示的图片序号，默认0
                    "data": [   //相册包含的图片，数组格式
                        {
                            "alt": "图片",
                            "pid": 1, //图片id
                            "src": imgSrc, //原图地址
                            "thumb": "" //缩略图地址
                        }
                    ]
                } ,anim: 5});
        });

        //点击[删除图片] 按钮， 事件
        $('.delImgBtn').click(function(){
            var divElem = $(this).parent();
            divElem.find('.imgVal').val(""); //清空图片真实路径
            divElem.find('.uploadImgBtn').text("上传图片");
            divElem.find('.uploadImg').attr("src", "").addClass('layui-hide');
            divElem.find('.delImgBtn').addClass('layui-hide');
            form.render();
        });

        $('.delImgsBtn').click(function () {
            multiple_images = [];
            $('#div-slide_show').empty();
            $('.delImgsBtn').addClass('layui-hide');
        });

        laydate.render({
            elem: '#producedBeginTime'
            ,type: 'date'
            ,format: 'yyyy-MM-dd'
            ,trigger: 'click'
        });

        //多图片上传
        upload.render({
            elem: '#multiple_img_upload'
            ,url: layui.setter.baseUrl + '/upload/goods'
            ,headers: headers
            ,multiple: true
            ,before: function(obj){
                var count = 0;
                // 预读本地文件示例，不支持ie8
                obj.preview(
                    function(index, file, result){
                    count ++;
                    // 判断当前多图个数是否高于4个
                    if (count > 4) {
                        layer.msg("超过详情图个数上限！");
                        return false;
                    }
                    $('#div-slide_show').append('<img style="height:38px; margin-left:30px;cursor: pointer;" src="'+ result +'" alt="'+ file.name
                        +'" title="" class="layui-upload-img uploadImg">')
                });
            }
            ,done: function(res){
                $('.delImgsBtn').removeClass('layui-hide');
                //如果上传成功
                if (res.code == 0) {
                    //追加图片成功追加文件名至图片容器
                    multiple_images.push(res.data);
                    // 判断当前多图个数是否高于4个
                    if (multiple_images.length > 4) {
                        layer.msg("超过详情图个数上限！");
                        return false;
                    }else{
                        $('.multiple_show_img').val(multiple_images);
                        // console.log(multiple_images)
                    }
                }
            }
        });

        form.render();

    })
</script>